@page "/creator/add-task"
@inject ITaskService TaskService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<EditForm Model="@newTask" OnValidSubmit="@HandleAddTask">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="title">Tiêu đề:</label>
        <InputText id="title" @bind-Value="newTask.Title"
                   class="form-control" />
        <ValidationMessage For="@(() => newTask.Title)" />
    </div>

    <div class="form-group">
        <label for="assignee">Người được giao:</label>
        <InputText id="assignee" @bind-Value="newTask.AssigneeUsername"
                   class="form-control" />
        <ValidationMessage For="@(() => newTask.AssigneeUsername)" />
    </div>

    <div class="form-group">
        <label for="dueDate">Hạn hoàn thành:</label>
        <InputDate id="dueDate" @bind-Value="newTask.DueDate"
                   class="form-control" />
        <ValidationMessage For="@(() => newTask.DueDate)" />
    </div>

    <div class="form-group">
        <label for="description">Mô tả:</label>
        <InputTextArea id="description" @bind-Value="newTask.Description"
                       class="form-control" rows="4" />
    </div>

    <button type="submit" class="btn btn-primary" disabled="@isLoading">
        @if (isLoading)
        {
            <span>Đang giao...</span>
        }
        else
        {
            <span>Giao Task</span>
        }
    </button>
</EditForm>

@code {
    private WorkTask newTask = new()
    {
        AssignDate = DateTime.Today,
        DueDate = DateTime.Today.AddDays(7)
    };

    private bool isLoading = false;

    private async Task HandleAddTask()
    {
        isLoading = true;

        var user = await AuthService.GetCurrentUserAsync();
        if (user != null)
        {
            newTask.CreatedBy = user.Username;
            newTask.CreatedAt = DateTime.Now;
            newTask.UpdatedAt = DateTime.Now;
            newTask.GroupId = "group-id-here"; // Lấy từ parameter

            var result = await TaskService.AddTaskAsync(newTask);
            if (result)
            {
                Navigation.NavigateTo("/creator/dashboard");
            }
        }

        isLoading = false;
    }
}